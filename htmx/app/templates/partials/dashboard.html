{% for widget in widgets %}
<section
  id="widget-{{ widget.id }}"
  class="{{ widget.css_class }} widget-loader"
  data-widget-id="{{ widget.id }}"
  data-widget-kind="{{ widget.kind }}"
  data-expandable="{{ 'true' if widget.kind == 'chart' and widget.expandable|default(true) else 'false' }}"
  data-impact-mode="size"
  data-flow-mode="usx"
  data-health-schema="dexes"
  data-health-attribute="Write Rate"
  data-health-base-schema="dexes"
  data-base-endpoint="{{ widget.endpoint }}"
  {% if widget.detail_table_endpoint %}data-detail-table-endpoint="{{ widget.detail_table_endpoint }}"{% endif %}
  hx-get="{{ widget.endpoint }}"
  hx-request='{"timeout":90000}'
  hx-trigger="load delay:{{ widget.load_delay_seconds }}s, dashboard-refresh from:body, impact-mode-change, flow-mode-change, distribution-mode-change, ohlcv-interval-change, health-schema-change from:body, health-attribute-change from:body, health-base-schema-change from:body, every {{ widget.refresh_interval_seconds }}s"
  hx-sync="this:replace"
  hx-swap="none"
>
  <div class="panel-header">
    <div class="panel-title-group">
      <h3>{{ widget.title }}</h3>
      {% if widget.tooltip %}
      <span class="info-tip-wrap" role="note">
        <svg class="info-tip-icon" width="14" height="14" viewBox="0 0 16 16" fill="none" aria-hidden="true"><circle cx="8" cy="8" r="7" stroke="currentColor" stroke-width="1.3"/><text x="8" y="12" text-anchor="middle" fill="currentColor" font-size="11" font-weight="600">i</text></svg>
        <span class="info-tip-card">{{ widget.tooltip }}</span>
      </span>
      {% endif %}
    </div>
    {% if widget.id == "trade-impact-toggle" %}
      <select id="trade-impact-mode" class="filter-select chart-mode-select" aria-label="Trade impact chart mode">
        <option value="size">Order Size for Target bps</option>
        <option value="impact">Impact bps at 3 Size Levels</option>
      </select>
    {% elif widget.id == "swaps-distribution-toggle" %}
      <select id="swaps-distribution-mode" class="filter-select chart-mode-select" aria-label="Swaps distribution chart mode">
        <option value="sell-order">Sell Order Distribution</option>
        <option value="net-sell-pressure">Net Sell Pressure Distribution</option>
      </select>
    {% elif widget.id == "swaps-flows-toggle" %}
      <select id="swaps-flow-mode" class="filter-select chart-mode-select" aria-label="Swap flow token and side">
        <option value="usx" selected>USX</option>
        <option value="usdc">USDC</option>
      </select>
    {% elif widget.id == "swaps-ohlcv" %}
      <select id="swaps-ohlcv-interval" class="filter-select chart-mode-select" aria-label="OHLCV candle interval">
        <option value="1m">1m</option>
        <option value="5m">5m</option>
        <option value="15m">15m</option>
        <option value="1h" selected>1h</option>
        <option value="4h">4h</option>
        <option value="1d">1d</option>
      </select>
    {% elif widget.id == "health-queue-chart" %}
      <select id="health-schema-select" class="filter-select chart-mode-select" aria-label="Schema">
        <option value="dexes" selected>dexes</option>
        <option value="exponent">exponent</option>
        <option value="kamino_lend">kamino_lend</option>
        <option value="solstice_proprietary">solstice_proprietary</option>
      </select>
      <select id="health-attribute-select" class="filter-select chart-mode-select" aria-label="Attribute">
        <option value="Write Rate" selected>Write Rate (rows/min)</option>
        <option value="Queue Size">Queue Size (% capacity)</option>
        <option value="Gap Size">Gap Size (seconds)</option>
        <option value="Failures">Failures (avg. per interval)</option>
      </select>
    {% elif widget.id == "health-base-chart-events" or widget.id == "health-base-chart-accounts" %}
      <select class="health-base-schema-select filter-select chart-mode-select" aria-label="Schema">
        <option value="dexes" selected>dexes</option>
        <option value="exponent">exponent</option>
        <option value="kamino_lend">kamino_lend</option>
        <option value="solstice_proprietary">solstice_proprietary</option>
      </select>
    {% endif %}
    <span class="panel-updated" id="updated-{{ widget.id }}">loading...</span>
  </div>
  <div class="panel-body">
    {% if widget.kind == "kpi" %}
      <div class="kpi-primary" id="kpi-primary-{{ widget.id }}">--</div>
      <div class="kpi-secondary" id="kpi-secondary-{{ widget.id }}"></div>
    {% elif widget.kind == "table" %}
      <div id="info-toggle-{{ widget.id }}" class="health-info-toggle-wrap"></div>
      <div id="table-{{ widget.id }}" class="table-wrap"></div>
      <div id="table-subtitle-{{ widget.id }}" class="table-subtitle"></div>
    {% elif widget.kind == "table-split" %}
      <div class="table-split">
        <div>
          <h4 id="table-left-title-{{ widget.id }}"></h4>
          <div id="table-left-{{ widget.id }}" class="table-wrap"></div>
        </div>
        <div>
          <h4 id="table-right-title-{{ widget.id }}"></h4>
          <div id="table-right-{{ widget.id }}" class="table-wrap"></div>
        </div>
      </div>
    {% else %}
      {% if widget.expandable|default(true) %}
        <button
          class="action-button icon-button chart-expand-btn chart-expand-fab"
          type="button"
          data-widget-id="{{ widget.id }}"
          aria-label="Open larger chart view"
          title="Open larger chart view"
        >
          <span class="expand-icon" aria-hidden="true">â¤¢</span>
        </button>
      {% endif %}
      {% if widget.detail_table_endpoint %}
        <button
          class="action-button icon-button detail-table-btn"
          type="button"
          data-widget-id="{{ widget.id }}"
          aria-label="View detail table"
          title="View detail table"
        >
          <svg class="detail-table-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true">
            <rect x="1" y="2" width="14" height="12" rx="1.5" stroke="currentColor" stroke-width="1.3"/>
            <line x1="1" y1="5.5" x2="15" y2="5.5" stroke="currentColor" stroke-width="1.3"/>
            <line x1="5.5" y1="5.5" x2="5.5" y2="14" stroke="currentColor" stroke-width="1.3"/>
            <line x1="10.5" y1="5.5" x2="10.5" y2="14" stroke="currentColor" stroke-width="1.3"/>
            <line x1="1" y1="9.5" x2="15" y2="9.5" stroke="currentColor" stroke-width="1.3"/>
          </svg>
        </button>
      {% endif %}
      <div id="chart-{{ widget.id }}" class="chart-canvas chart-expand-target"></div>
    {% endif %}
  </div>
</section>
{% endfor %}
