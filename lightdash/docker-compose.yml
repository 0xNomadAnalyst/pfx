# =============================================================================
# Lightdash - Local Self-Hosted (Docker Compose)
# =============================================================================
# Usage:
#   docker compose up -d
#   Open http://localhost:8080
#
# To stop:
#   docker compose down
#
# To stop AND wipe all data (fresh start):
#   docker compose down -v
# =============================================================================

services:

  # ---------------------------------------------------------------------------
  # MinIO - local S3-compatible object storage (results cache, exports, etc.)
  # ---------------------------------------------------------------------------
  minio:
    image: coollabsio/minio:latest
    ports:
      - "9000:9000"
      - "9001:9001"   # MinIO web console
    volumes:
      - minio-data:/data
      - ./docker/init-minio.sh:/init-minio.sh
    entrypoint: "/init-minio.sh"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
      MINIO_DEFAULT_BUCKETS: lightdash
      MINIO_EXPIRATION_DAYS: 7

  # ---------------------------------------------------------------------------
  # Postgres - internal metadata database (stores Lightdash state, NOT your data)
  # ---------------------------------------------------------------------------
  db:
    image: postgres:15.4
    restart: always
    environment:
      POSTGRES_PASSWORD: ${PGPASSWORD}
      POSTGRES_USER: ${PGUSER:-postgres}
      POSTGRES_DB: ${PGDATABASE:-lightdash}
    volumes:
      - db-data:/var/lib/postgresql/data
    ports:
      - "5433:5432"   # Exposed on 5433 to avoid conflict with any local Postgres

  # ---------------------------------------------------------------------------
  # Lightdash - the BI application
  # ---------------------------------------------------------------------------
  lightdash:
    platform: linux/amd64
    image: lightdash/lightdash:latest
    depends_on:
      - db
      - minio
    environment:
      # Postgres connection
      - PGHOST=${PGHOST:-db}
      - PGPORT=${PGPORT:-5432}
      - PGUSER=${PGUSER:-postgres}
      - PGPASSWORD=${PGPASSWORD}
      - PGDATABASE=${PGDATABASE:-lightdash}
      # Core settings
      - LIGHTDASH_SECRET=${LIGHTDASH_SECRET}
      - PORT=${PORT:-8080}
      - SITE_URL=${SITE_URL:-http://localhost:8080}
      - SECURE_COOKIES=${SECURE_COOKIES:-false}
      - TRUST_PROXY=${TRUST_PROXY:-false}
      - LIGHTDASH_LOG_LEVEL=${LIGHTDASH_LOG_LEVEL:-debug}
      - LIGHTDASH_INSTALL_TYPE=${LIGHTDASH_INSTALL_TYPE:-docker_image}
      - LIGHTDASH_QUERY_MAX_LIMIT=${LIGHTDASH_QUERY_MAX_LIMIT:-5000}
      - LIGHTDASH_MAX_PAYLOAD=${LIGHTDASH_MAX_PAYLOAD:-5mb}
      - ALLOW_MULTIPLE_ORGS=${ALLOW_MULTIPLE_ORGS:-false}
      - SCHEDULER_ENABLED=${SCHEDULER_ENABLED:-true}
      # S3 / MinIO object storage
      - S3_ENDPOINT=http://minio:9000
      - S3_REGION=us-east-1
      - S3_BUCKET=lightdash
      - S3_ACCESS_KEY=minioadmin
      - S3_SECRET_KEY=minioadmin
      - S3_FORCE_PATH_STYLE=true
      - S3_EXPIRATION_TIME=${S3_EXPIRATION_TIME:-259200}
    volumes:
      - "${DBT_PROJECT_DIR:-./dbt_project}:/usr/app/dbt"
    ports:
      - "${PORT:-8080}:${PORT:-8080}"

# =============================================================================
# Named volumes - data persists across restarts; `docker compose down -v` to wipe
# =============================================================================
volumes:
  db-data:
  minio-data:
